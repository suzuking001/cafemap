<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>é£Ÿã¹æ­©ããƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ»åå·®å€¤ï¼‰</title>

  <!-- Leaflet & ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://unpkg.com/chroma-js@2.4.2/chroma.min.js"></script>

  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    :root{
      --bg: #0b0d12;
      --panel: rgba(22,25,32,.78);
      --border: rgba(255,255,255,.10);
      --text: #e9eef7;
      --muted: #9aa3b2;
      --accent: #4ea1ff;
      --accent-2:#7cddff;
      --chip:#1e2735;
      --danger:#ff6b6b;
      --ok:#2ecc71;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 14px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f5f7fb; --panel:rgba(255,255,255,.92); --border:rgba(0,0,0,.07);
        --text:#0f1728; --muted:#5e6b80; --chip:#eef2f8; --shadow:0 10px 30px rgba(13,27,62,.12);
      }
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif}
    #map{height:100vh;width:100%}

    /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
    .panel{
      position:absolute;inset:auto auto 20px 20px;z-index:1000;max-height:calc(100vh - 40px);
      width:360px;background:var(--panel);backdrop-filter: blur(14px);
      border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
      display:flex;flex-direction:column;overflow:hidden;
    }
    .panel header{display:flex;align-items:center;gap:10px;padding:12px 14px 10px;border-bottom:1px solid var(--border)}
    .title{font-weight:700;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px}
    .content{padding:10px 12px 14px;overflow:auto}
    .row{display:flex;align-items:center;gap:10px}
    .grid{display:grid;gap:8px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .divider{height:1px;background:var(--border);margin:10px 0}

    /* æ¤œç´¢ãƒ»ãƒãƒƒãƒ— */
    .search{display:flex;align-items:center;gap:8px;background:var(--chip);border-radius:10px;padding:6px 10px}
    .search input{all:unset;flex:1}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;background:var(--chip);font-size:12px;color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .badge.ok{border-color:#1f9d64;color:#1f9d64}
    .badge.warn{border-color:#b45309;color:#b45309}

    /* ã‚¹ã‚¤ãƒƒãƒ & ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
    .switch{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
    .switch input{appearance:none;width:42px;height:22px;background:#778;border-radius:999px;position:relative;outline:none;transition:.2s}
    .switch input:checked{background:var(--accent)}
    .switch input::after{content:"";position:absolute;top:3px;left:3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:.2s}
    .switch input:checked::after{transform:translateX(20px)}
    .slider-row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
    input[type=range]{-webkit-appearance:none;width:100%;height:6px;background:linear-gradient(90deg,var(--accent),var(--accent-2));border-radius:999px;outline:none}
    input[type=range]::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#fff;border:2px solid var(--accent);cursor:pointer}
    .cat-line{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%}

    /* è‰²åˆ†å¸ƒã®å‡¡ä¾‹ */
    .heat-legend{height:8px;border-radius:999px;border:1px solid var(--border);
      background:linear-gradient(90deg,#ffffb2,#fecc5c,#fd8d3c,#f03b20,#bd0026)}

    /* ãƒœã‚¿ãƒ³ */
    .btn{appearance:none;border:none;border-radius:10px;padding:8px 12px;cursor:pointer;color:#fff;background:var(--accent);box-shadow:0 6px 18px rgba(78,161,255,.35)}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border);box-shadow:none}
    .btn.warn{background:var(--danger)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    /* FAB (ç”Ÿæˆ) */
    .fab{
      position:absolute;right:22px;bottom:22px;z-index:1001;display:flex;align-items:center;gap:10px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));border:none;color:#001018;
      padding:14px 18px;border-radius:16px;font-weight:700;letter-spacing:.2px;box-shadow:0 14px 36px rgba(78,161,255,.45);cursor:pointer;
    }
    .fab .spinner{width:16px;height:16px;border:2px solid rgba(0,0,0,.2);border-top-color:#001018;border-radius:50%;animation:spin 1s linear infinite;display:none}
    .fab.loading .spinner{display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
    details{border:1px solid var(--border);border-radius:10px;padding:8px;background:rgba(255,255,255,.03)}
    details>summary{cursor:pointer;list-style:none}
    details>summary::-webkit-details-marker{display:none}

    /* åå·®å€¤ãƒ©ãƒ™ãƒ« */
    .dev-label{color:#fff;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.5)}

    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast{
      position:absolute;left:50%;bottom:92px;transform:translateX(-50%);
      background:var(--panel);border:1px solid var(--border);backdrop-filter:blur(10px);
      padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:1002;display:none
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width:820px){
      .panel{left:12px;right:12px;bottom:auto;top:12px;width:auto;max-height:60vh}
      .fab{right:14px;bottom:14px}
      .toast{bottom:84px}
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
  <aside class="panel" id="panel">
    <header>
      <div>
        <div class="title">é£Ÿã¹æ­©ããƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</div>
        <div class="sub">å¯å¤‰ã‚°ãƒªãƒƒãƒ‰ / é‡ã¿ä»˜ã‘ / åå·®å€¤</div>
      </div>
      <div style="margin-left:auto" class="badge" id="loaded-badge" title="èª­ã¿è¾¼ã¿ãƒ‡ãƒ¼ã‚¿">æœªèª­è¾¼</div>
    </header>

    <div class="content">
      <div class="grid" style="gap:10px">
        <div class="search" title="ã‚«ãƒ†ã‚´ãƒªåã§çµã‚Šè¾¼ã¿">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.2-4.2M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          <input id="filter-input" placeholder="ã‚«ãƒ†ã‚´ãƒªã‚’æ¤œç´¢â€¦">
          <button class="btn ghost" id="btn-all">å…¨é¸æŠ</button>
          <button class="btn ghost" id="btn-none">å…¨è§£é™¤</button>
        </div>

        <div class="grid cols-2" style="align-items:center">
          <label class="switch" title="ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— / åå·®å€¤ã®è¡¨ç¤ºåˆ‡æ›¿">
            <input type="checkbox" id="cb-heat" checked>
            <span>ğŸ”¥ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</span>
          </label>
          <label class="switch" title="åå·®å€¤ãƒ©ãƒ™ãƒ«è¡¨ç¤ºåˆ‡æ›¿" style="justify-self:end">
            <input type="checkbox" id="cb-labels" checked>
            <span>ãƒ©ãƒ™ãƒ«</span>
          </label>
        </div>

        <div class="grid" style="gap:6px">
          <div class="slider-row">
            <span class="sub" style="width:84px">ã‚°ãƒªãƒƒãƒ‰</span>
            <input type="range" id="grid-size" min="0.2" max="1.2" step="0.1" value="0.4">
            <output class="sub" id="grid-out">0.4 km</output>
          </div>
          <div class="grid cols-2">
            <span class="sub">å°‘ãªã„</span>
            <span class="sub" style="text-align:right">å¤šã„</span>
          </div>
          <div class="heat-legend"></div>
          <label class="switch" title="å€‹åˆ¥ã®ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºåˆ‡æ›¿">
            <input type="checkbox" id="cb-points" checked>
            <span>ãƒã‚¤ãƒ³ãƒˆ</span>
          </label>
        </div>

        <details open>
          <summary>ã‚«ãƒ†ã‚´ãƒª & é‡ã¿ (0.0-1.0)</summary>
          <div id="legend" class="grid" style="margin-top:8px"></div>
        </details>

        <details>
          <summary>ãƒ‡ãƒ¼ã‚¿</summary>
          <div class="grid" style="margin-top:8px">
            <div class="row">
              <button class="btn" id="btn-save" title="ç¾åœ¨ã®å–å¾—çµæœã‚’GeoJSONã§ä¿å­˜">ä¿å­˜ (GeoJSON)</button>
              <button class="btn ghost" id="btn-load">èª­ã¿è¾¼ã¿</button>
              <input type="file" id="file-input" accept=".json,.geojson,application/json" style="display:none">
            </div>
            <label class="switch" title="èª­ã¿è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§ç”Ÿæˆï¼ˆOverpassç„¡åŠ¹ï¼‰">
              <input type="checkbox" id="use-loaded">
              <span>èª­ã¿è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨</span>
            </label>
            <div class="row" style="justify-content:space-between">
              <span class="sub">èª­ã¿è¾¼ã¿çŠ¶æ³</span>
              <span class="badge" id="loaded-info">â€”</span>
            </div>
          </div>
        </details>
      </div>
    </div>
  </aside>

  <!-- ç”Ÿæˆãƒœã‚¿ãƒ³ -->
  <button class="fab" id="btn-gen">
    <span class="spinner" id="fab-spin"></span>
    ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ç”Ÿæˆ
  </button>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div class="toast" id="toast"></div>

<script>
/***** 1. ã‚«ãƒ†ã‚´ãƒªå®šç¾©ï¼ˆé£Ÿã¹æ­©ãå‘ã‘ï¼‰ *****/
const CATS=[
  {id:'curry', label:'ã‚«ãƒ¬ãƒ¼', color:'#d97706',
    clauses:['["amenity"~"^(restaurant|fast_food)$"]','["cuisine"~"curry",i]'],
    test:(tg)=> /^(restaurant|fast_food)$/.test(tg.amenity||'') && /curry/i.test(tg.cuisine||'')},
  {id:'ramen', label:'ãƒ©ãƒ¼ãƒ¡ãƒ³', color:'#e11d48',
    clauses:['["amenity"~"^(restaurant|fast_food)$"]','["cuisine"~"(ramen|ãƒ©ãƒ¼ãƒ¡ãƒ³)",i]'],
    test:(tg,name)=> /^(restaurant|fast_food)$/.test(tg.amenity||'') && (/ramen|ãƒ©ãƒ¼ãƒ¡ãƒ³/i.test(tg.cuisine||'')||/ãƒ©ãƒ¼ãƒ¡ãƒ³/.test(name||''))},
  {id:'sushi', label:'å¯¿å¸', color:'#0ea5e9',
    clauses:['["amenity"="restaurant"]','["cuisine"~"(sushi|å¯¿å¸)",i]'],
    test:(tg,name)=> tg.amenity==='restaurant' && (/sushi|å¯¿å¸/i.test(tg.cuisine||'')||/å¯¿å¸/.test(name||''))},
  {id:'patisserie', label:'ãƒ‘ãƒ†ã‚£ã‚¹ãƒªãƒ¼', color:'#f472b6',
    clauses:['["shop"="pastry"]'],
    test:(tg,name)=> tg.shop==='pastry' || /patisserie|ãƒ‘ãƒ†ã‚£ã‚¹ãƒªãƒ¼/i.test(name||'')},
  {id:'bakery', label:'ãƒ™ãƒ¼ã‚«ãƒªãƒ¼', color:'#a16207',
    clauses:['["shop"="bakery"]'],
    test:(tg)=> tg.shop==='bakery'},
  {id:'confectionery', label:'å’Œè“å­ãƒ»è“å­', color:'#22c55e',
    clauses:['["shop"="confectionery"]'],
    test:(tg)=> tg.shop==='confectionery'},
  {id:'ice_cream', label:'ã‚¢ã‚¤ã‚¹', color:'#60a5fa',
    clauses:['["amenity"="ice_cream"]'],
    test:(tg)=> tg.amenity==='ice_cream'},
  {id:'cafe', label:'ã‚«ãƒ•ã‚§', color:'#8b5cf6',
    clauses:['["amenity"="cafe"]'],
    test:(tg)=> tg.amenity==='cafe'},
  {id:'restaurant', label:'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', color:'#fb7185',
    clauses:['["amenity"="restaurant"]'],
    test:(tg)=> tg.amenity==='restaurant'}
];

/***** 2. UI ç”Ÿæˆ *****/
const legend=document.getElementById('legend');
function makeCatRow(c){
  const row=document.createElement('div');
  row.className='cat-line';
  row.dataset.cat = c.id;
  row.innerHTML=`
    <input type="checkbox" id="chk-${c.id}" checked>
    <div class="row" style="gap:10px">
      <span class="dot" style="background:${c.color}"></span>
      <span>${c.label}</span>
    </div>
    <div class="slider-row">
      <span class="sub" style="width:28px;text-align:right">0</span>
      <input type="range" id="wt-${c.id}" min="0" max="1" step="0.1" value="0.7" />
      <output class="sub" for="wt-${c.id}" id="out-${c.id}">0.7</output>
    </div>
  `;
  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¡¨ç¤ºæ›´æ–°
  const slider = row.querySelector(`#wt-${c.id}`);
  const out = row.querySelector(`#out-${c.id}`);
  slider.addEventListener('input',()=>{ out.textContent = Number(slider.value).toFixed(1); });
  return row;
}
CATS.forEach(c=>legend.appendChild(makeCatRow(c)));

/***** 3. Map åˆæœŸåŒ– *****/
const map=L.map('map',{zoomControl:true}).setView([35.6812,139.7671],14); // æ±äº¬é§…å‘¨è¾º
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

let gridLayer,labelLayer; const pointLayers={};
const heatCB=document.getElementById('cb-heat');
const toastEl=document.getElementById('toast');
const fab=document.getElementById('btn-gen');
const fabSpin=document.getElementById('fab-spin');
const loadedBadge=document.getElementById('loaded-badge');
const loadedInfo=document.getElementById('loaded-info');
const gridSizeEl=document.getElementById('grid-size');
const gridOutEl=document.getElementById('grid-out');
const labelsCB=document.getElementById('cb-labels');
const pointsCB=document.getElementById('cb-points');

document.getElementById('btn-all').addEventListener('click',()=>toggleAll(true));
document.getElementById('btn-none').addEventListener('click',()=>toggleAll(false));
document.getElementById('filter-input').addEventListener('input',filterCats);
gridSizeEl.addEventListener('input',()=>{ gridOutEl.textContent = `${Number(gridSizeEl.value).toFixed(1)} km`; });

heatCB.addEventListener('change',toggleHeat);
labelsCB.addEventListener('change',toggleHeat);
pointsCB.addEventListener('change',()=>{
  Object.values(pointLayers).forEach(l=>{ if(pointsCB.checked) map.addLayer(l); else map.removeLayer(l); });
});
document.getElementById('btn-gen').addEventListener('click',generate);

/* ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ UI */
document.getElementById('btn-save').addEventListener('click',saveGeoJSON);
document.getElementById('btn-load').addEventListener('click',()=>document.getElementById('file-input').click());
document.getElementById('file-input').addEventListener('change',onFileChosen);

/* èª­ã¿è¾¼ã¿æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿/ç›´è¿‘ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ */
let loadedDataset=null;  // {type:'FeatureCollection', features:[Point...]}
let lastExport=null;

function showToast(msg, type=''){
  toastEl.textContent=msg;
  toastEl.style.display='block';
  toastEl.style.borderColor = type==='error' ? 'var(--danger)' : 'var(--border)';
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toastEl.style.display='none', 2400);
}
function toggleAll(flag){
  CATS.forEach(c=>{ const el=document.getElementById(`chk-${c.id}`); if(el) el.checked=flag; });
}
function filterCats(e){
  const q=(e.target.value||'').trim().toLowerCase();
  [...legend.children].forEach(ch=>{
    const id=ch.dataset.cat;
    const cat=CATS.find(c=>c.id===id);
    const text=(cat?.label+' '+cat?.id)||'';
    ch.style.display = text.toLowerCase().includes(q) ? '' : 'none';
  });
}

function toggleHeat(){
  const on=heatCB.checked;
  if(gridLayer)  on?map.addLayer(gridLayer):map.removeLayer(gridLayer);
  const labelsOn = labelsCB.checked && on;
  if(labelLayer) labelsOn?map.addLayer(labelLayer):map.removeLayer(labelLayer);
}

/***** 4. ãƒ¡ã‚¤ãƒ³ç”Ÿæˆ *****/
async function generate(){
  fab.classList.add('loading'); fab.disabled=true;
  let errorMsg='';
  try{
    /* 4-1 é¸æŠ & é‡ã¿ */
    const selected=CATS.filter(c=>document.getElementById(`chk-${c.id}`).checked);
    if(!selected.length){ showToast('å°‘ãªãã¨ã‚‚1ã¤é¸æŠã—ã¦ãã ã•ã„','error'); return; }
    const weights={}; selected.forEach(c=>{
      const v=parseFloat(document.getElementById(`wt-${c.id}`).value)||0;
      weights[c.id]=Math.max(0,Math.min(1,v));
    });

    /* 4-2 æ—¢å­˜ãƒ¬ã‚¤ãƒ¤ã‚’ã‚¯ãƒªã‚¢ */
    if(gridLayer) map.removeLayer(gridLayer); if(labelLayer) map.removeLayer(labelLayer);
    Object.values(pointLayers).forEach(l=>map.removeLayer(l));

    /* 4-3 ç¾åœ¨ã®è¡¨ç¤ºç¯„å›² */
    const b=map.getBounds(); const bb=[b.getSouth(),b.getWest(),b.getNorth(),b.getEast()];

    /* 4-4 ãƒ‡ãƒ¼ã‚¿å–å¾— or èª­ã¿è¾¼ã¿ */
    const useLoaded = document.getElementById('use-loaded').checked && loadedDataset;
    const catPts={}; selected.forEach(c=>catPts[c.id]=[]);
    let allFeatures=[];

    if(useLoaded){
      loadedDataset.features.forEach(fe=>{
        if(!fe || !fe.geometry || fe.geometry.type!=='Point') return;
        const k=fe.properties?.category;
        if(!k || !(k in catPts)) return;
        const [lon,lat]=fe.geometry.coordinates;
        const pt=turf.point([lon,lat], fe.properties||{});
        catPts[k].push(pt); allFeatures.push(pt);
      });
    }else{
      /* Overpass ã‚¯ã‚¨ãƒªï¼ˆã‚«ãƒ†ã‚´ãƒªæ¯ã®æ¡ä»¶ã‚’çµåˆï¼‰ */
      const qLines=[]; selected.forEach(c=>{
        const clause = Array.isArray(c.clauses) ? c.clauses.join('') : `[${c.filter}]`;
        ['node','way','rel'].forEach(t=>qLines.push(`${t}${clause}(${bb[0]},${bb[1]},${bb[2]},${bb[3]});`));
      });
      const query=`[out:json][timeout:40];\n(\n${qLines.join('\n')}\n);\nout center;`;

      // OverpassãƒŸãƒ©ãƒ¼ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      const ENDPOINTS=[
        'https://overpass-api.de/api/interpreter',
        'https://overpass.kumi.systems/api/interpreter',
        'https://overpass.openstreetmap.ru/api/interpreter',
        'https://overpass.osm.ch/api/interpreter'
      ];
      let data; let lastErr;
      for(const ep of ENDPOINTS){
        try{
          const res=await fetch(ep,{
            method:'POST',
            headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8','Accept':'application/json'},
            body:'data='+encodeURIComponent(query)
          });
          if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          data=await res.json();
          break;
        }catch(e){ lastErr=e; }
      }
      if(!data) throw new Error('API å–å¾—å¤±æ•—: '+(lastErr?.message||'unknown'));

      const push=(k,pt)=>{ if(catPts[k]){ pt.properties=Object.assign({category:k}, pt.properties||{}); catPts[k].push(pt); allFeatures.push(pt); } };
      data.elements.forEach(el=>{
        const lat=el.lat??el.center?.lat, lon=el.lon??el.center?.lon; if(!(lat&&lon)) return;
        const tg=el.tags||{}; const name=tg.name||''; const pt=turf.point([lon,lat],tg);
        selected.forEach(c=>{ if(typeof c.test==='function' && c.test(tg,name)) push(c.id,pt); });
      });
      if(!allFeatures.length) throw new Error('è©²å½“æ–½è¨­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }

    if(!Object.values(catPts).some(v=>v.length)){
      throw new Error('è©²å½“æ–½è¨­ãªã—ï¼ˆèª­ã¿è¾¼ã¿ãƒ‡ãƒ¼ã‚¿/é¸æŠã‚«ãƒ†ã‚´ãƒªã®çµ„ã¿åˆã‚ã›ï¼‰');
    }

    /* 4-5 ã‚°ãƒªãƒƒãƒ‰ & ã‚¹ã‚³ã‚¢ */
    const cellKm = Math.max(0.1, Math.min(5, parseFloat(gridSizeEl.value)||0.4));
    const grid=turf.squareGrid([bb[1],bb[0],bb[3],bb[2]],cellKm,{units:'kilometers'});
    const scores=[];
    grid.features.forEach(cell=>{
      let s=0;
      Object.entries(catPts).forEach(([k,arr])=>{
        const w=weights[k]; if(!w) return;
        arr.forEach(pt=>{ if(turf.booleanPointInPolygon(pt,cell)) s+=w; });
      });
      cell.properties.score=s; scores.push(s);
    });

    /* 4-6 åå·®å€¤ */
    const ave=scores.reduce((a,b)=>a+b,0)/scores.length;
    const std=Math.sqrt(scores.reduce((a,b)=>a+(b-ave)**2,0)/scores.length)||1e-9;
    grid.features.forEach(f=>f.properties.dev=Math.round(50+10*(f.properties.score-ave)/std));

    /* 4-7 ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— & ãƒ©ãƒ™ãƒ« */
    const maxScore=Math.max(...scores);
    const scale=chroma.scale('YlOrRd').domain([0,maxScore||1]);
    gridLayer=L.geoJson(grid,{style:f=>({fillColor:scale(f.properties.score).hex(),color:'#444',weight:0.4,fillOpacity:0.55}),
      onEachFeature:(f,l)=>l.bindPopup(`Score: ${f.properties.score.toFixed(2)}<br>åå·®å€¤: ${f.properties.dev}`)});
    labelLayer=L.layerGroup();
    grid.features.forEach(f=>{
      const [lon,lat]=turf.centerOfMass(f).geometry.coordinates;
      L.marker([lat,lon],{icon:L.divIcon({className:'dev-label',html:f.properties.dev,iconSize:[24,12]})}).addTo(labelLayer);
    });
    toggleHeat();

    /* 4-8 å€‹åˆ¥ç‚¹ */
    const bounds = [];
    selected.forEach(c=>{
      const pts=catPts[c.id]; if(!pts.length) return;
      pointLayers[c.id]=L.geoJson(turf.featureCollection(pts),{
        pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:3,color:c.color,weight:0.6,fillOpacity:0.85})
      });
      if(pointsCB.checked) pointLayers[c.id].addTo(map);
      pts.forEach(p=>bounds.push([p.geometry.coordinates[1],p.geometry.coordinates[0]]));
    });
    // if(bounds.length){ map.fitBounds(bounds); }

    /* 4-9 ä¿å­˜ç”¨ */
    if(useLoaded){
      lastExport = loadedDataset;
    }else{
      lastExport = { type:'FeatureCollection', features:(allFeatures||[]).map(f=>f),
        meta:{ created:new Date().toISOString(), bbox:bb, categories:selected.map(c=>c.id) } };
    }

    showToast('ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  }catch(err){
    errorMsg = err.message||String(err);
    showToast(errorMsg,'error');
    console.error(err);
  }finally{
    fab.classList.remove('loading'); fab.disabled=false;
  }
}

/***** 5. ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ *****/
function saveGeoJSON(){
  if(!lastExport){ showToast('ä¿å­˜ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã€Œç”Ÿæˆã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„','error'); return; }
  const blob=new Blob([JSON.stringify(lastExport,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const stamp=new Date().toISOString().replace(/[:.]/g,'-');
  a.href=url; a.download=`foodmap_${stamp}.geojson`;
  document.body.appendChild(a); a.click();
  URL.revokeObjectURL(url); a.remove();
  showToast('GeoJSONã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

async function onFileChosen(e){
  const f=e.target.files[0];
  e.target.value='';
  if(!f) return;
  try{
    const text=await f.text();
    const json=JSON.parse(text);
    if(json.type!=='FeatureCollection' || !Array.isArray(json.features)) throw new Error('GeoJSON FeatureCollection ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
    const feats=(json.features||[]).filter(fe=>
      fe && fe.geometry && fe.geometry.type==='Point' &&
      Array.isArray(fe.geometry.coordinates) && fe.geometry.coordinates.length===2 &&
      fe.properties && fe.properties.category
    );
    if(!feats.length) throw new Error('Point ã‹ã¤ properties.category ä»˜ãè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

    loadedDataset={type:'FeatureCollection',features:feats};
    loadedInfo.textContent=`${feats.length} ç‚¹`;
    loadedBadge.textContent='èª­è¾¼æ¸ˆã¿'; loadedBadge.classList.add('ok'); loadedBadge.classList.remove('warn');
    document.getElementById('use-loaded').checked=true;
    showToast('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  }catch(err){
    loadedDataset=null;
    loadedInfo.textContent='â€”';
    loadedBadge.textContent='æœªèª­è¾¼'; loadedBadge.classList.remove('ok'); loadedBadge.classList.add('warn');
    showToast('èª­ã¿è¾¼ã¿å¤±æ•—: '+err.message,'error');
  }
}
</script>
</body>
</html>
